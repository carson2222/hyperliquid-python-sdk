from typing import Literal, TypedDict, Union

import requests
from eth_account import Account
from eth_account.signers.local import LocalAccount
from web3 import Web3
from web3.middleware import SignAndSendRawMiddlewareBuilder

from hyperliquid.utils import constants
from hyperliquid.utils.signing import get_timestamp_ms, sign_l1_action


class CreateInputParams(TypedDict):
    nonce: int


class CreateInput(TypedDict):
    create: CreateInputParams


FinalizeEvmContractInput = Union[Literal["firstStorageSlot"], CreateInput]


class FinalizeEvmContractAction(TypedDict):
    type: Literal["finalizeEvmContract"]
    token: int
    input: FinalizeEvmContractInput


SHOULD_DEPLOY_CONTRACT = True  # change this if you are happy with your deployed contract and want to skip this
SHOULD_LINK_CONTRACT = False  # change this to True if you want to link your token, this process is not reversible!
# DEFAULT_CONTRACT_ADDRESS = Web3.to_checksum_address(
#     "0x8cDE56336E289c028C8f7CF5c20283fF02272182"  # change this to your contract address if you are skipping deploying
# )
TOKEN = 128  # note that if changing this you likely should also change the abi to have a different name and perhaps also different decimals and initial supply

# HERE!!!!!!!!!!!!!!!:
PRIVATE_KEY = ""  # Change this to your private key

# Connect to the JSON-RPC endpoint
rpc_url = "https://rpc.hyperliquid.xyz/evm"
w3 = Web3(Web3.HTTPProvider(rpc_url))

# The account will be used both for deploying the ERC20 contract and linking it to your native spot asset
# You can also switch this to create an account a different way if you don't want to include a secret key in code
if PRIVATE_KEY == "0xPRIVATE_KEY":
    raise Exception("must set private key or create account another way")
account: LocalAccount = Account.from_key(PRIVATE_KEY)
print(f"Running with address {account.address}")
w3.middleware_onion.add(SignAndSendRawMiddlewareBuilder.build(account))
w3.eth.default_account = account.address
# Verify connection
if not w3.is_connected():
    raise Exception("Failed to connect to the Ethereum network")

purr_abi = {
    "_format": "hh-sol-artifact-1",
    "contractName": "Yeeti",
    "sourceName": "contracts/Yeeti.sol",
    "abi": [
        {"inputs": [], "stateMutability": "nonpayable", "type": "constructor"},
        {"inputs": [], "name": "InvalidShortString", "type": "error"},
        {
            "inputs": [{"internalType": "string", "name": "str", "type": "string"}],
            "name": "StringTooLong",
            "type": "error",
        },
        {
            "anonymous": False,
            "inputs": [
                {"indexed": True, "internalType": "address", "name": "owner", "type": "address"},
                {"indexed": True, "internalType": "address", "name": "spender", "type": "address"},
                {"indexed": False, "internalType": "uint256", "name": "value", "type": "uint256"},
            ],
            "name": "Approval",
            "type": "event",
        },
        {"anonymous": False, "inputs": [], "name": "EIP712DomainChanged", "type": "event"},
        {
            "anonymous": False,
            "inputs": [
                {"indexed": True, "internalType": "address", "name": "from", "type": "address"},
                {"indexed": True, "internalType": "address", "name": "to", "type": "address"},
                {"indexed": False, "internalType": "uint256", "name": "value", "type": "uint256"},
            ],
            "name": "Transfer",
            "type": "event",
        },
        {
            "inputs": [],
            "name": "DOMAIN_SEPARATOR",
            "outputs": [{"internalType": "bytes32", "name": "", "type": "bytes32"}],
            "stateMutability": "view",
            "type": "function",
        },
        {
            "inputs": [
                {"internalType": "address", "name": "owner", "type": "address"},
                {"internalType": "address", "name": "spender", "type": "address"},
            ],
            "name": "allowance",
            "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
            "stateMutability": "view",
            "type": "function",
        },
        {
            "inputs": [
                {"internalType": "address", "name": "spender", "type": "address"},
                {"internalType": "uint256", "name": "amount", "type": "uint256"},
            ],
            "name": "approve",
            "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
            "stateMutability": "nonpayable",
            "type": "function",
        },
        {
            "inputs": [{"internalType": "address", "name": "account", "type": "address"}],
            "name": "balanceOf",
            "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
            "stateMutability": "view",
            "type": "function",
        },
        {
            "inputs": [],
            "name": "decimals",
            "outputs": [{"internalType": "uint8", "name": "", "type": "uint8"}],
            "stateMutability": "view",
            "type": "function",
        },
        {
            "inputs": [
                {"internalType": "address", "name": "spender", "type": "address"},
                {"internalType": "uint256", "name": "subtractedValue", "type": "uint256"},
            ],
            "name": "decreaseAllowance",
            "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
            "stateMutability": "nonpayable",
            "type": "function",
        },
        {
            "inputs": [],
            "name": "eip712Domain",
            "outputs": [
                {"internalType": "bytes1", "name": "fields", "type": "bytes1"},
                {"internalType": "string", "name": "name", "type": "string"},
                {"internalType": "string", "name": "version", "type": "string"},
                {"internalType": "uint256", "name": "chainId", "type": "uint256"},
                {"internalType": "address", "name": "verifyingContract", "type": "address"},
                {"internalType": "bytes32", "name": "salt", "type": "bytes32"},
                {"internalType": "uint256[]", "name": "extensions", "type": "uint256[]"},
            ],
            "stateMutability": "view",
            "type": "function",
        },
        {
            "inputs": [
                {"internalType": "address", "name": "spender", "type": "address"},
                {"internalType": "uint256", "name": "addedValue", "type": "uint256"},
            ],
            "name": "increaseAllowance",
            "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
            "stateMutability": "nonpayable",
            "type": "function",
        },
        {
            "inputs": [],
            "name": "name",
            "outputs": [{"internalType": "string", "name": "", "type": "string"}],
            "stateMutability": "view",
            "type": "function",
        },
        {
            "inputs": [{"internalType": "address", "name": "owner", "type": "address"}],
            "name": "nonces",
            "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
            "stateMutability": "view",
            "type": "function",
        },
        {
            "inputs": [
                {"internalType": "address", "name": "owner", "type": "address"},
                {"internalType": "address", "name": "spender", "type": "address"},
                {"internalType": "uint256", "name": "value", "type": "uint256"},
                {"internalType": "uint256", "name": "deadline", "type": "uint256"},
                {"internalType": "uint8", "name": "v", "type": "uint8"},
                {"internalType": "bytes32", "name": "r", "type": "bytes32"},
                {"internalType": "bytes32", "name": "s", "type": "bytes32"},
            ],
            "name": "permit",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function",
        },
        {
            "inputs": [],
            "name": "symbol",
            "outputs": [{"internalType": "string", "name": "", "type": "string"}],
            "stateMutability": "view",
            "type": "function",
        },
        {
            "inputs": [],
            "name": "totalSupply",
            "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
            "stateMutability": "view",
            "type": "function",
        },
        {
            "inputs": [
                {"internalType": "address", "name": "to", "type": "address"},
                {"internalType": "uint256", "name": "amount", "type": "uint256"},
            ],
            "name": "transfer",
            "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
            "stateMutability": "nonpayable",
            "type": "function",
        },
        {
            "inputs": [
                {"internalType": "address", "name": "from", "type": "address"},
                {"internalType": "address", "name": "to", "type": "address"},
                {"internalType": "uint256", "name": "amount", "type": "uint256"},
            ],
            "name": "transferFrom",
            "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
            "stateMutability": "nonpayable",
            "type": "function",
        },
    ],
    "bytecode": "610160604052348015610010575f5ffd5b506040518060400160405280600581526020017f5945455449000000000000000000000000000000000000000000000000000000815250806040518060400160405280600181526020017f31000000000000000000000000000000000000000000000000000000000000008152506040518060400160405280600581526020017f59656574690000000000000000000000000000000000000000000000000000008152506040518060400160405280600581526020017f594545544900000000000000000000000000000000000000000000000000000081525081600390816100f991906106d0565b50806004908161010991906106d0565b50505061012060058361021260201b90919060201c565b610120818152505061013c60068261021260201b90919060201c565b6101408181525050818051906020012060e08181525050808051906020012061010081815250504660a0818152505061017961025f60201b60201c565b608081815250503073ffffffffffffffffffffffffffffffffffffffff1660c08173ffffffffffffffffffffffffffffffffffffffff16815250505050505f73200000000000000000000000000000000000008090505f633b9aca00905061020b826101e96102b960201b60201c565b600a6101f59190610907565b836102009190610951565b6102c160201b60201c565b5050610c16565b5f6020835110156102335761022c8361041b60201b60201c565b9050610259565b826102438361048060201b60201c565b5f01908161025191906106d0565b5060ff5f1b90505b92915050565b5f7f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f60e05161010051463060405160200161029e9594939291906109f8565b60405160208183030381529060405280519060200120905090565b5f6012905090565b5f73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160361032f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161032690610aa3565b60405180910390fd5b6103405f838361048960201b60201c565b8060025f8282546103519190610ac1565b92505081905550805f5f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f82825401925050819055508173ffffffffffffffffffffffffffffffffffffffff165f73ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef836040516103fe9190610af4565b60405180910390a36104175f838361048e60201b60201c565b5050565b5f5f829050601f8151111561046757826040517f305a27a900000000000000000000000000000000000000000000000000000000815260040161045e9190610b63565b60405180910390fd5b80518161047390610bb0565b5f1c175f1b915050919050565b5f819050919050565b505050565b505050565b5f81519050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f600282049050600182168061050e57607f821691505b602082108103610521576105206104ca565b5b50919050565b5f819050815f5260205f209050919050565b5f6020601f8301049050919050565b5f82821b905092915050565b5f600883026105837fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82610548565b61058d8683610548565b95508019841693508086168417925050509392505050565b5f819050919050565b5f819050919050565b5f6105d16105cc6105c7846105a5565b6105ae565b6105a5565b9050919050565b5f819050919050565b6105ea836105b7565b6105fe6105f6826105d8565b848454610554565b825550505050565b5f5f905090565b610615610606565b6106208184846105e1565b505050565b5b81811015610643576106385f8261060d565b600181019050610626565b5050565b601f8211156106885761065981610527565b61066284610539565b81016020851015610671578190505b61068561067d85610539565b830182610625565b50505b505050565b5f82821c905092915050565b5f6106a85f198460080261068d565b1980831691505092915050565b5f6106c08383610699565b9150826002028217905092915050565b6106d982610493565b67ffffffffffffffff8111156106f2576106f161049d565b5b6106fc82546104f7565b610707828285610647565b5f60209050601f831160018114610738575f8415610726578287015190505b61073085826106b5565b865550610797565b601f19841661074686610527565b5f5b8281101561076d57848901518255600182019150602085019450602081019050610748565b8683101561078a5784890151610786601f891682610699565b8355505b6001600288020188555050505b505050505050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f8160011c9050919050565b5f5f8291508390505b6001851115610821578086048111156107fd576107fc61079f565b5b600185161561080c5780820291505b808102905061081a856107cc565b94506107e1565b94509492505050565b5f8261083957600190506108f4565b81610846575f90506108f4565b816001811461085c576002811461086657610895565b60019150506108f4565b60ff8411156108785761087761079f565b5b8360020a91508482111561088f5761088e61079f565b5b506108f4565b5060208310610133831016604e8410600b84101617156108ca5782820a9050838111156108c5576108c461079f565b5b6108f4565b6108d784848460016107d8565b925090508184048111156108ee576108ed61079f565b5b81810290505b9392505050565b5f60ff82169050919050565b5f610911826105a5565b915061091c836108fb565b92506109497fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff848461082a565b905092915050565b5f61095b826105a5565b9150610966836105a5565b9250828202610974816105a5565b9150828204841483151761098b5761098a61079f565b5b5092915050565b5f819050919050565b6109a481610992565b82525050565b6109b3816105a5565b82525050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6109e2826109b9565b9050919050565b6109f2816109d8565b82525050565b5f60a082019050610a0b5f83018861099b565b610a18602083018761099b565b610a25604083018661099b565b610a3260608301856109aa565b610a3f60808301846109e9565b9695505050505050565b5f82825260208201905092915050565b7f45524332303a206d696e7420746f20746865207a65726f2061646472657373005f82015250565b5f610a8d601f83610a49565b9150610a9882610a59565b602082019050919050565b5f6020820190508181035f830152610aba81610a81565b9050919050565b5f610acb826105a5565b9150610ad6836105a5565b9250828201905080821115610aee57610aed61079f565b5b92915050565b5f602082019050610b075f8301846109aa565b92915050565b8281835e5f83830152505050565b5f601f19601f8301169050919050565b5f610b3582610493565b610b3f8185610a49565b9350610b4f818560208601610b0d565b610b5881610b1b565b840191505092915050565b5f6020820190508181035f830152610b7b8184610b2b565b905092915050565b5f81519050919050565b5f819050602082019050919050565b5f610ba78251610992565b80915050919050565b5f610bba82610b83565b82610bc484610b8d565b9050610bcf81610b9c565b92506020821015610c0f57610c0a7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff83602003600802610548565b831692505b5050919050565b60805160a05160c05160e05161010051610120516101405161212b610c675f395f61055801525f61052401525f61101501525f610ff401525f610dbd01525f610e1301525f610e3c015261212b5ff3fe608060405234801561000f575f5ffd5b50600436106100f3575f3560e01c806370a0823111610095578063a457c2d711610064578063a457c2d7146102a1578063a9059cbb146102d1578063d505accf14610301578063dd62ed3e1461031d576100f3565b806370a08231146101ff5780637ecebe001461022f57806384b0196e1461025f57806395d89b4114610283576100f3565b806323b872dd116100d157806323b872dd14610163578063313ce567146101935780633644e515146101b157806339509351146101cf576100f3565b806306fdde03146100f7578063095ea7b31461011557806318160ddd14610145575b5f5ffd5b6100ff61034d565b60405161010c9190611426565b60405180910390f35b61012f600480360381019061012a91906114d7565b6103dd565b60405161013c919061152f565b60405180910390f35b61014d6103ff565b60405161015a9190611557565b60405180910390f35b61017d60048036038101906101789190611570565b610408565b60405161018a919061152f565b60405180910390f35b61019b610436565b6040516101a891906115db565b60405180910390f35b6101b961043e565b6040516101c6919061160c565b60405180910390f35b6101e960048036038101906101e491906114d7565b61044c565b6040516101f6919061152f565b60405180910390f35b61021960048036038101906102149190611625565b610482565b6040516102269190611557565b60405180910390f35b61024960048036038101906102449190611625565b6104c7565b6040516102569190611557565b60405180910390f35b610267610514565b60405161027a9796959493929190611750565b60405180910390f35b61028b610611565b6040516102989190611426565b60405180910390f35b6102bb60048036038101906102b691906114d7565b6106a1565b6040516102c8919061152f565b60405180910390f35b6102eb60048036038101906102e691906114d7565b610716565b6040516102f8919061152f565b60405180910390f35b61031b60048036038101906103169190611826565b610738565b005b610337600480360381019061033291906118c3565b610877565b6040516103449190611557565b60405180910390f35b60606003805461035c9061192e565b80601f01602080910402602001604051908101604052809291908181526020018280546103889061192e565b80156103d35780601f106103aa576101008083540402835291602001916103d3565b820191905f5260205f20905b8154815290600101906020018083116103b657829003601f168201915b5050505050905090565b5f5f6103e76108f9565b90506103f4818585610900565b600191505092915050565b5f600254905090565b5f5f6104126108f9565b905061041f858285610ac3565b61042a858585610b4e565b60019150509392505050565b5f6012905090565b5f610447610dba565b905090565b5f5f6104566108f9565b90506104778185856104688589610877565b610472919061198b565b610900565b600191505092915050565b5f5f5f8373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20549050919050565b5f61050d60075f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20610e70565b9050919050565b5f6060805f5f5f606061055160057f0000000000000000000000000000000000000000000000000000000000000000610e7c90919063ffffffff16565b61058560067f0000000000000000000000000000000000000000000000000000000000000000610e7c90919063ffffffff16565b46305f5f1b5f67ffffffffffffffff8111156105a4576105a36119be565b5b6040519080825280602002602001820160405280156105d25781602001602082028036833780820191505090505b507f0f00000000000000000000000000000000000000000000000000000000000000959493929190965096509650965096509650965090919293949596565b6060600480546106209061192e565b80601f016020809104026020016040519081016040528092919081815260200182805461064c9061192e565b80156106975780601f1061066e57610100808354040283529160200191610697565b820191905f5260205f20905b81548152906001019060200180831161067a57829003601f168201915b5050505050905090565b5f5f6106ab6108f9565b90505f6106b88286610877565b9050838110156106fd576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016106f490611a5b565b60405180910390fd5b61070a8286868403610900565b60019250505092915050565b5f5f6107206108f9565b905061072d818585610b4e565b600191505092915050565b8342111561077b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161077290611ac3565b60405180910390fd5b5f7f6e71edae12b1b97f4d1f60370fef10105fa2faae0126114a169c64845d6126c98888886107a98c610f29565b896040516020016107bf96959493929190611ae1565b6040516020818303038152906040528051906020012090505f6107e182610f84565b90505f6107f082878787610f9d565b90508973ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1614610860576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161085790611b8a565b60405180910390fd5b61086b8a8a8a610900565b50505050505050505050565b5f60015f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2054905092915050565b5f33905090565b5f73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff160361096e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161096590611c18565b60405180910390fd5b5f73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16036109dc576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016109d390611ca6565b60405180910390fd5b8060015f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20819055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92583604051610ab69190611557565b60405180910390a3505050565b5f610ace8484610877565b90507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8114610b485781811015610b3a576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610b3190611d0e565b60405180910390fd5b610b478484848403610900565b5b50505050565b5f73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610bbc576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610bb390611d9c565b60405180910390fd5b5f73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603610c2a576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610c2190611e2a565b60405180910390fd5b610c35838383610fc6565b5f5f5f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2054905081811015610cb8576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610caf90611eb8565b60405180910390fd5b8181035f5f8673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2081905550815f5f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f82825401925050819055508273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef84604051610da19190611557565b60405180910390a3610db4848484610fcb565b50505050565b5f7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff163073ffffffffffffffffffffffffffffffffffffffff16148015610e3557507f000000000000000000000000000000000000000000000000000000000000000046145b15610e62577f00000000000000000000000000000000000000000000000000000000000000009050610e6d565b610e6a610fd0565b90505b90565b5f815f01549050919050565b606060ff5f1b8314610e9857610e9183611065565b9050610f23565b818054610ea49061192e565b80601f0160208091040260200160405190810160405280929190818152602001828054610ed09061192e565b8015610f1b5780601f10610ef257610100808354040283529160200191610f1b565b820191905f5260205f20905b815481529060010190602001808311610efe57829003601f168201915b505050505090505b92915050565b5f5f60075f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f209050610f7381610e70565b9150610f7e816110d7565b50919050565b5f610f96610f90610dba565b836110eb565b9050919050565b5f5f5f610fac8787878761112b565b91509150610fb981611203565b8192505050949350505050565b505050565b505050565b5f7f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f7f00000000000000000000000000000000000000000000000000000000000000007f0000000000000000000000000000000000000000000000000000000000000000463060405160200161104a959493929190611ed6565b60405160208183030381529060405280519060200120905090565b60605f61107183611368565b90505f602067ffffffffffffffff81111561108f5761108e6119be565b5b6040519080825280601f01601f1916602001820160405280156110c15781602001600182028036833780820191505090505b5090508181528360208201528092505050919050565b6001815f015f828254019250508190555050565b5f6040517f190100000000000000000000000000000000000000000000000000000000000081528360028201528260228201526042812091505092915050565b5f5f7f7fffffffffffffffffffffffffffffff5d576e7357a4501ddfe92f46681b20a0835f1c1115611163575f6003915091506111fa565b5f6001878787876040515f81526020016040526040516111869493929190611f27565b6020604051602081039080840390855afa1580156111a6573d5f5f3e3d5ffd5b5050506020604051035190505f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16036111f2575f600192509250506111fa565b805f92509250505b94509492505050565b5f600481111561121657611215611f6a565b5b81600481111561122957611228611f6a565b5b0315611365576001600481111561124357611242611f6a565b5b81600481111561125657611255611f6a565b5b03611296576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161128d90611fe1565b60405180910390fd5b600260048111156112aa576112a9611f6a565b5b8160048111156112bd576112bc611f6a565b5b036112fd576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016112f490612049565b60405180910390fd5b6003600481111561131157611310611f6a565b5b81600481111561132457611323611f6a565b5b03611364576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161135b906120d7565b60405180910390fd5b5b50565b5f5f60ff835f1c169050601f8111156113ad576040517fb3512b0c00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b80915050919050565b5f81519050919050565b5f82825260208201905092915050565b8281835e5f83830152505050565b5f601f19601f8301169050919050565b5f6113f8826113b6565b61140281856113c0565b93506114128185602086016113d0565b61141b816113de565b840191505092915050565b5f6020820190508181035f83015261143e81846113ee565b905092915050565b5f5ffd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6114738261144a565b9050919050565b61148381611469565b811461148d575f5ffd5b50565b5f8135905061149e8161147a565b92915050565b5f819050919050565b6114b6816114a4565b81146114c0575f5ffd5b50565b5f813590506114d1816114ad565b92915050565b5f5f604083850312156114ed576114ec611446565b5b5f6114fa85828601611490565b925050602061150b858286016114c3565b9150509250929050565b5f8115159050919050565b61152981611515565b82525050565b5f6020820190506115425f830184611520565b92915050565b611551816114a4565b82525050565b5f60208201905061156a5f830184611548565b92915050565b5f5f5f6060848603121561158757611586611446565b5b5f61159486828701611490565b93505060206115a586828701611490565b92505060406115b6868287016114c3565b9150509250925092565b5f60ff82169050919050565b6115d5816115c0565b82525050565b5f6020820190506115ee5f8301846115cc565b92915050565b5f819050919050565b611606816115f4565b82525050565b5f60208201905061161f5f8301846115fd565b92915050565b5f6020828403121561163a57611639611446565b5b5f61164784828501611490565b91505092915050565b5f7fff0000000000000000000000000000000000000000000000000000000000000082169050919050565b61168481611650565b82525050565b61169381611469565b82525050565b5f81519050919050565b5f82825260208201905092915050565b5f819050602082019050919050565b6116cb816114a4565b82525050565b5f6116dc83836116c2565b60208301905092915050565b5f602082019050919050565b5f6116fe82611699565b61170881856116a3565b9350611713836116b3565b805f5b8381101561174357815161172a88826116d1565b9750611735836116e8565b925050600181019050611716565b5085935050505092915050565b5f60e0820190506117635f83018a61167b565b818103602083015261177581896113ee565b9050818103604083015261178981886113ee565b90506117986060830187611548565b6117a5608083018661168a565b6117b260a08301856115fd565b81810360c08301526117c481846116f4565b905098975050505050505050565b6117db816115c0565b81146117e5575f5ffd5b50565b5f813590506117f6816117d2565b92915050565b611805816115f4565b811461180f575f5ffd5b50565b5f81359050611820816117fc565b92915050565b5f5f5f5f5f5f5f60e0888a03121561184157611840611446565b5b5f61184e8a828b01611490565b975050602061185f8a828b01611490565b96505060406118708a828b016114c3565b95505060606118818a828b016114c3565b94505060806118928a828b016117e8565b93505060a06118a38a828b01611812565b92505060c06118b48a828b01611812565b91505092959891949750929550565b5f5f604083850312156118d9576118d8611446565b5b5f6118e685828601611490565b92505060206118f785828601611490565b9150509250929050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f600282049050600182168061194557607f821691505b60208210810361195857611957611901565b5b50919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f611995826114a4565b91506119a0836114a4565b92508282019050808211156119b8576119b761195e565b5b92915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b7f45524332303a2064656372656173656420616c6c6f77616e63652062656c6f775f8201527f207a65726f000000000000000000000000000000000000000000000000000000602082015250565b5f611a456025836113c0565b9150611a50826119eb565b604082019050919050565b5f6020820190508181035f830152611a7281611a39565b9050919050565b7f45524332305065726d69743a206578706972656420646561646c696e650000005f82015250565b5f611aad601d836113c0565b9150611ab882611a79565b602082019050919050565b5f6020820190508181035f830152611ada81611aa1565b9050919050565b5f60c082019050611af45f8301896115fd565b611b01602083018861168a565b611b0e604083018761168a565b611b1b6060830186611548565b611b286080830185611548565b611b3560a0830184611548565b979650505050505050565b7f45524332305065726d69743a20696e76616c6964207369676e617475726500005f82015250565b5f611b74601e836113c0565b9150611b7f82611b40565b602082019050919050565b5f6020820190508181035f830152611ba181611b68565b9050919050565b7f45524332303a20617070726f76652066726f6d20746865207a65726f206164645f8201527f7265737300000000000000000000000000000000000000000000000000000000602082015250565b5f611c026024836113c0565b9150611c0d82611ba8565b604082019050919050565b5f6020820190508181035f830152611c2f81611bf6565b9050919050565b7f45524332303a20617070726f766520746f20746865207a65726f2061646472655f8201527f7373000000000000000000000000000000000000000000000000000000000000602082015250565b5f611c906022836113c0565b9150611c9b82611c36565b604082019050919050565b5f6020820190508181035f830152611cbd81611c84565b9050919050565b7f45524332303a20696e73756666696369656e7420616c6c6f77616e63650000005f82015250565b5f611cf8601d836113c0565b9150611d0382611cc4565b602082019050919050565b5f6020820190508181035f830152611d2581611cec565b9050919050565b7f45524332303a207472616e736665722066726f6d20746865207a65726f2061645f8201527f6472657373000000000000000000000000000000000000000000000000000000602082015250565b5f611d866025836113c0565b9150611d9182611d2c565b604082019050919050565b5f6020820190508181035f830152611db381611d7a565b9050919050565b7f45524332303a207472616e7366657220746f20746865207a65726f20616464725f8201527f6573730000000000000000000000000000000000000000000000000000000000602082015250565b5f611e146023836113c0565b9150611e1f82611dba565b604082019050919050565b5f6020820190508181035f830152611e4181611e08565b9050919050565b7f45524332303a207472616e7366657220616d6f756e74206578636565647320625f8201527f616c616e63650000000000000000000000000000000000000000000000000000602082015250565b5f611ea26026836113c0565b9150611ead82611e48565b604082019050919050565b5f6020820190508181035f830152611ecf81611e96565b9050919050565b5f60a082019050611ee95f8301886115fd565b611ef660208301876115fd565b611f0360408301866115fd565b611f106060830185611548565b611f1d608083018461168a565b9695505050505050565b5f608082019050611f3a5f8301876115fd565b611f4760208301866115cc565b611f5460408301856115fd565b611f6160608301846115fd565b95945050505050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602160045260245ffd5b7f45434453413a20696e76616c6964207369676e617475726500000000000000005f82015250565b5f611fcb6018836113c0565b9150611fd682611f97565b602082019050919050565b5f6020820190508181035f830152611ff881611fbf565b9050919050565b7f45434453413a20696e76616c6964207369676e6174757265206c656e677468005f82015250565b5f612033601f836113c0565b915061203e82611fff565b602082019050919050565b5f6020820190508181035f83015261206081612027565b9050919050565b7f45434453413a20696e76616c6964207369676e6174757265202773272076616c5f8201527f7565000000000000000000000000000000000000000000000000000000000000602082015250565b5f6120c16022836113c0565b91506120cc82612067565b604082019050919050565b5f6020820190508181035f8301526120ee816120b5565b905091905056fea2646970667358221220bc124acf23190eaa75a51fde5d51c285fd076c90231a5c3d9ccbf110d530dac864736f6c634300081c0033",
    "deployedBytecode": "",
    "linkReferences": {},
    "deployedLinkReferences": {},
}

creation_nonce: int
if SHOULD_DEPLOY_CONTRACT:
    Purr = w3.eth.contract(abi=purr_abi["abi"], bytecode=purr_abi["bytecode"])
    creation_nonce = w3.eth.get_transaction_count(account.address)
    tx_hash = Purr.constructor().transact()
    print("constructor tx_hash", tx_hash, creation_nonce)
    tx_receipt = w3.eth.wait_for_transaction_receipt(tx_hash)
    print("constructor tx_receipt", tx_receipt)
    contract_address = tx_receipt["contractAddress"]
    purr = w3.eth.contract(address=contract_address, abi=purr_abi["abi"])

    # initial_supply = w3.to_wei(1_000_000_000, "ether")  # this should match the max supply on the L1
    # tx_hash = purr.functions.mint("0x11d81fEb8F50448d7E58fCCf7Aa9fEeb5c7FAf73", initial_supply).transact()
    # print("mint tx_hash", tx_hash)
    # tx_receipt = w3.eth.wait_for_transaction_receipt(tx_hash)
    # print("mint tx_receipt", tx_receipt)

    # tx_hash = purr.functions.transfer("0x2222222222222222222222222222222222222222", initial_supply).transact()
    # print("transfer tx_hash", tx_hash)
    # tx_receipt = w3.eth.wait_for_transaction_receipt(tx_hash)
    # print("transfer tx_receipt", tx_receipt)

    # print(purr.functions.balanceOf("0x2222222222222222222222222222222222222222").call())
else:
    contract_address = DEFAULT_CONTRACT_ADDRESS
    creation_nonce = 0

if SHOULD_LINK_CONTRACT:
    if contract_address is None:
        raise Exception("contract address cannot be None")
    action = {
        "type": "spotDeploy",
        "requestEvmContract": {
            "token": TOKEN,
            "address": contract_address.lower(),
            "evmExtraWeiDecimals": 13,
        },
    }
    nonce = get_timestamp_ms()
    signature = sign_l1_action(account, action, None, nonce, False)
    payload = {
        "action": action,
        "nonce": nonce,
        "signature": signature,
        "vaultAddress": None,
    }
    response = requests.post(constants.TESTNET_API_URL + "/exchange", json=payload, timeout=10)
    print(response.json())

    use_create_finalization = True
    finalize_action: FinalizeEvmContractAction
    if use_create_finalization:
        finalize_action = {
            "type": "finalizeEvmContract",
            "token": TOKEN,
            "input": {"create": {"nonce": creation_nonce}},
        }
    else:
        finalize_action = {"type": "finalizeEvmContract", "token": TOKEN, "input": "firstStorageSlot"}
    nonce = get_timestamp_ms()
    signature = sign_l1_action(account, finalize_action, None, nonce, False)
    payload = {
        "action": finalize_action,
        "nonce": nonce,
        "signature": signature,
        "vaultAddress": None,
    }
    response = requests.post(constants.TESTNET_API_URL + "/exchange", json=payload, timeout=10)
    print(response.json())
